<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!--Converted with LaTeX2HTML 2002-2-1 (1.70)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>13. Authorization scenarios</TITLE>
<META NAME="description" CONTENT="13. Authorization scenarios">
<META NAME="keywords" CONTENT="sympa">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<META NAME="Generator" CONTENT="LaTeX2HTML v2002-2-1">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="sympa.css">

<LINK REL="next" HREF="node15.html">
<LINK REL="previous" HREF="node13.html">
<LINK REL="up" HREF="sympa.html">
<LINK REL="next" HREF="node15.html">
</HEAD>

<BODY TEXT="#000000" BGCOLOR="#ffffff">
<!--Navigation Panel-->
<A NAME="tex2html1159"
  HREF="node15.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html1153"
  HREF="sympa.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html1147"
  HREF="node13.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html1155"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html1157"
  HREF="node30.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html1160"
  HREF="node15.html">14. virtual host</A>
<B> Up:</B> <A NAME="tex2html1154"
  HREF="sympa.html">Sympa Mailing Lists Management Software version</A>
<B> Previous:</B> <A NAME="tex2html1148"
  HREF="node13.html">12. Authentication</A>
 &nbsp; <B>  <A NAME="tex2html1156"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A NAME="tex2html1158"
  HREF="node30.html">Index</A></B> 
<BR>
<BR>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsections</STRONG></A>

<UL>
<LI><A NAME="tex2html1161"
  HREF="node14.html#SECTION001410000000000000000">13.1 rules specifications</A>
<LI><A NAME="tex2html1162"
  HREF="node14.html#SECTION001420000000000000000">13.2 LDAP Named Filters</A>
<UL>
<LI><A NAME="tex2html1163"
  HREF="node14.html#SECTION001421000000000000000">13.2.1 Definition</A>
<LI><A NAME="tex2html1164"
  HREF="node14.html#SECTION001422000000000000000">13.2.2 Search Condition</A>
</UL>
<BR>
<LI><A NAME="tex2html1165"
  HREF="node14.html#SECTION001430000000000000000">13.3 scenario inclusion</A>
<LI><A NAME="tex2html1166"
  HREF="node14.html#SECTION001440000000000000000">13.4 Hidding scenario files</A>
</UL>
<!--End of Table of Child-Links-->
<HR>

<H1><A NAME="SECTION001400000000000000000"></A>
<A NAME="scenarios"></A><A NAME="1907"></A>
<BR>
13. Authorization scenarios
</H1>

<P>
List parameters controlling the behavior of commands are linked to different authorization scenarios.
For example : the <A NAME="9110"></A><TT>send private</TT> parameter is related to the send.private scenario.
There are four possible locations for a authorization scenario. When <I>Sympa</I> seeks to apply an authorization scenario, it
looks first in the related list directory <A NAME="9126"></A><TT>/usr/local/sympa-stable/expl/<TT>&lt;</TT>list<TT>&gt;</TT>/scenari</TT>. If it
does not find the file there, it scans the current robot configuration directory <A NAME="9135"></A><TT>/usr/local/sympa-stable/etc/my.domain.org/scenari</TT>, then the site's configuration directory <A NAME="9138"></A><TT>/usr/local/sympa-stable/etc/scenari</TT>,
and finally <A NAME="9141"></A><TT>/usr/local/sympa-stable/bin/etc/scenari</TT>, which is the directory installed by the Makefile.

<P>
An authorization scenario is a small configuration language to describe who
can perform an operation and which authentication method is requested for it.
An authorization scenario is an ordered set of rules. The goal is to provide a simple and
flexible way to configure authorization and required authentication method for each operation.

<P>
Each authorization scenario rule contains :

<UL>
<LI>a condition : the condition is evaluated by <I>Sympa</I>. It can use
  variables such as sender for the sender e-mail, list for the listname etc.
</LI>
<LI>an authentication method. The authentication method can be <A NAME="9145"></A><TT>smtp</TT>,
<A NAME="9148"></A><TT>md5</TT> or <A NAME="9151"></A><TT>smime</TT>. The rule is applied by <I>Sympa</I> if both condition
and authentication method match the runtime context. <A NAME="9155"></A><TT>smtp</TT> is used if
<I>Sympa</I> use the SMTP <A NAME="9159"></A><TT>from:</TT> header , <A NAME="9162"></A><TT>md5</TT> is used if a unique
md5 key as been returned by the requestor to validate her message, <A NAME="9165"></A><TT>smime</TT>
is used for signed messages (see <A HREF="node27.html#smimeforsign">26.4.3</A>, page&nbsp;<A HREF="node27.html#smimeforsign"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>).
</LI>
<LI>a returned atomic action that will be executed by <I>Sympa</I> if the rule matches

<P>
</LI>
</UL>

<P>
Example

<P>
<BLOCKQUOTE>
del.auth
</BLOCKQUOTE><PRE>
title.us deletion performed only by list owners, need authentication
title.fr suppression réservée au propriétaire avec authentification
title.es eliminacin reservada slo para el propietario, necesita autentificacin


  is_owner([listname],[sender])  smtp       -&gt; request_auth
  is_listmaster([sender])        smtp       -&gt; request_auth
  true()                         md5,smime  -&gt; do_it
</PRE>

<P>

<H1><A NAME="SECTION001410000000000000000"></A>
<A NAME="rules"></A>
<BR>
13.1 rules specifications
</H1>

<P>
An authorization scenario consists of rules, evaluated in order beginning with the first. 
Rules are defined as follows :<PRE>
&lt;rule&gt; ::= &lt;condition&gt; &lt;auth_list&gt; -&gt; &lt;action&gt;

&lt;condition&gt; ::= [!] &lt;condition
                | true ()
                | all ()
                | equal (&lt;var&gt;, &lt;var&gt;)
                | match (&lt;var&gt;, /perl_regexp/)
		| search (&lt;filter.ldap&gt;,&lt;var&gt;)
                | is_subscriber (&lt;listname&gt;, &lt;var&gt;)
                | is_owner (&lt;listname&gt;, &lt;var&gt;)
                | is_editor (&lt;listname&gt;, &lt;var&gt;)
                | is_listmaster (&lt;var&gt;)
                | older (&lt;date&gt;, &lt;date&gt;)    # true if first date is anterior to the second date
                | newer (&lt;date&gt;, &lt;date&gt;)    # true if first date is posterior to the second date
&lt;var&gt; ::= [email] | [sender] | [user-&gt;&lt;user_key_word&gt;] | [previous_email]
                  | [remote_host] | [remote_addr] | [user_attributes-&gt;&lt;user_attributes_keyword&gt;]
	 	  | [subscriber-&gt;&lt;subscriber_key_word&gt;] | [list-&gt;&lt;list_key_word&gt;] | [env-&gt;&lt;env_var&gt;]
		  | [conf-&gt;&lt;conf_key_word&gt;] | [msg_header-&gt;&lt;smtp_key_word&gt;] | [msg_body] 
	 	  | [msg_part-&gt;type] | [msg_part-&gt;body] | [msg_encrypted] | [is_bcc] | [current_date] 
		  | [topic-auto] | [topic-sender,] | [topic-editor] | [topic] | [topic-needed]
		  | &lt;string&gt;

[is_bcc] ::= set to 1 if the list is neither in To: nor Cc:

[sender] ::= email address of the current user (used on web or mail interface). Default value is 'nobody'

[previous_email] ::= old email when changing subscription email in preference page. 

[msg_encrypted] ::= set to 'smime' if the message was S/MIME encrypted

[topic-auto] ::= topic of the message if it has been automatically tagged

[topic-sender] ::= topic of the message if it has been tagged by sender

[topic-editor] ::= topic of the message if it has been tagged by editor

[topic]  ::= topic of the message

[topic-needed] ::= the message has not got any topic and message topic are required for the list

&lt;date&gt; ::= '&lt;date_element&gt; [ +|- &lt;date_element&gt;]'

&lt;date_element&gt; ::= &lt;epoch_date&gt; | &lt;var&gt; | &lt;date_expr&gt;

&lt;epoch_date&gt; ::= &lt;integer&gt;

&lt;date_expr&gt; ::= &lt;integer&gt;y&lt;integer&gt;m&lt;integer&gt;d&lt;integer&gt;h&lt;integer&gt;min&lt;integer&gt;sec

&lt;listname&gt; ::= [listname] | &lt;listname_string&gt;

&lt;auth_list&gt; ::= &lt;auth&gt;,&lt;auth_list&gt; | &lt;auth&gt;

&lt;auth&gt; ::= smtp|md5|smime

&lt;action&gt; ::=   do_it [,notify]
             | do_it [,quiet]
	     | reject(reason=&lt;reason_key&gt;)
	     | reject(tt2=&lt;tpl_name&gt;)
             | request_auth
             | owner
	     | editor
	     | editorkey[,quiet]
	     | listmaster

&lt;reason_key&gt; ::= match a key in mail_tt2/authorization_reject.tt2 template corresponding to 
                 an information message about the reason of the reject of the user
  
&lt;tpl_name&gt; ::= corresponding template (&lt;tpl_name&gt;.tt2) is send to the sender

&lt;user_key_word&gt; ::= email | gecos | lang | password | cookie_delay_user
	            | &lt;additional_user_fields&gt;

&lt;user_attributes_key_word&gt; ::= one of the user attributes provided by the SSO system via environment variables. The [user_attributes] structure is available only if user authenticated with a generic_sso.

&lt;subscriber_key_word&gt; ::= email | gecos | bounce | reception 
	                  | visibility | date | update_date
			  | &lt;additional_subscriber_fields&gt;

&lt;list_key_word&gt; ::= name | host | lang | max_size | priority | reply_to | 
		    status | subject | account | total

&lt;conf_key_word&gt; ::= domain | email | listmaster | default_list_priority | 
		      sympa_priority | request_priority | lang | max_size
</PRE>

<P>
(Refer to  <A HREF="node17.html#tasks">16.8</A>, page&nbsp;<A HREF="node17.html#tasks"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A> for date format definition)

<P>
The function to evaluate scenario is described in section <A HREF="node29.html#list-scenario-evaluation">28.2.6</A>, page&nbsp;<A HREF="node29.html#list-scenario-evaluation"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>.

<P>
perl_regexp can contain the string [host] (interpreted at run time as the list or robot domain).
The variable notation [msg_header-<TT>&gt;&lt;</TT>smtp_key_word<TT>&gt;</TT>] is interpreted as the 
SMTP header value only when evaluating the authorization scenario for sending messages. 
It can be used, for example, to require editor validation for multipart messages.
[msg_part-<TT>&gt;</TT>type] and [msg_part-<TT>&gt;</TT>body] are the MIME parts content-types and bodies ; the body is available
for MIME parts in text/xxx format only.

<P>
The difference between <A NAME="9169"></A>editor and <A NAME="9170"></A>editorkey is, that with <A NAME="9171"></A>editor the message is simply forwarded to the moderaotr. He then can forward it to the list, if he wishes. <A NAME="9172"></A>editorkey assigns a key to the message and sends it to the moderator together with the message. So the moderator can just send back the key to distribute the message. Please note, that moderation from the webinterface is only possible when using <A NAME="9173"></A>editorkey, because otherwise there is no copy of the message saved on the server. 

<P>
A bunch of authorization scenarios is provided with the <I>Sympa</I> distribution ; they provide
a large set of configuration that allow to create lists for most usage. But you will
probably create authorization scenarios for your own need. In this case, don't forget to restart <I>Sympa</I> 
and wwsympa because authorization scenarios are not reloaded dynamicaly.

<P>
These standard authorization scenarios are located in the <A NAME="9176"></A><TT>/usr/local/sympa-stable/bin/etc/scenari/</TT>
directory. Default scenarios are named <TT>&lt;</TT>command<TT>&gt;</TT>.default.

<P>
You may also define and name your own authorization scenarios. Store them in the
<A NAME="9179"></A><TT>/usr/local/sympa-stable/etc/scenari</TT> directory. They will not be overwritten by Sympa release.
Scenarios can also be defined for a particular virtual host (using directory <A NAME="9194"></A><TT>/usr/local/sympa-stable/etc/<TT>&lt;</TT>robot<TT>&gt;</TT>/scenari</TT>) or for a list ( <A NAME="9221"></A><TT>/usr/local/sympa-stable/expl/<TT>&lt;</TT>robot<TT>&gt;</TT>/<TT>&lt;</TT>list<TT>&gt;</TT>/scenari</TT> ). <B>Sympa will not dynamically detect that a list config should be reloaded after a scenario has been changed on disk.</B>

<P>
Example:

<P>
Copy the previous scenario to <A NAME="9236"></A><TT>scenari/subscribe.rennes1</TT> :

<P><PRE>
equal([sender], 'userxxx@univ-rennes1.fr') smtp,smime -&gt; reject
match([sender], /univ-rennes1\.fr$/) smtp,smime -&gt; do_it
true()                               smtp,smime -&gt; owner
</PRE>

<P>
You may now refer to this authorization scenario in any list configuration file, for example :

<P><PRE>
subscribe rennes1
</PRE>

<P>

<H1><A NAME="SECTION001420000000000000000"></A>
<A NAME="named-filters"></A>
<BR>
13.2 LDAP Named Filters
</H1>

<P>
At the moment Named Filters are only used in authorization scenarios. They enable to select a category of people who will be authorized or not to realise some actions.

<P>
As a consequence, you can grant privileges in a list to people belonging to an <A NAME="9239"></A>LDAP directory thanks to an authorization scenario.

<P>

<H2><A NAME="SECTION001421000000000000000">
13.2.1 Definition</A>
</H2>

<P>
People are selected through an <A NAME="9240"></A>LDAP filter defined in a configuration file. This file must have the extension '.ldap'.It is stored in <A NAME="9241"></A><TT>/usr/local/sympa-stable/etc/search_filters/</TT>.

<P>
You must give several informations in order to create a Named Filter:

<UL>
<LI>host
<BR>
A list of host:port LDAP directories (replicates) entries.

<P>
</LI>
<LI>suffix
<BR>
Defines the naming space covered by the search (optional, depending on the LDAP server).

<P>
</LI>
<LI>filter
<BR>
Defines the LDAP search filter (RFC 2254 compliant). 
	But you must absolutely take into account the first part of the filter which is:
	('mail_attribute' = [sender]) as shown in the example. you will have to replce 'mail_attribute' by the name 
	of the attribute for the email.
	<I>Sympa</I> verifies if the user belongs to the category of people defined in the filter. 

<P>
</LI>
<LI>scope
<BR>
By default the search is performed on the whole tree below the specified base object. This may be changed by specifying a scope :

<P>

<UL>
<LI>base : Search only the base object.
</LI>
<LI>one
<BR>
Search the entries immediately below the base object. 
</LI>
<LI>sub
<BR>
Search the whole tree below the base object. This is the default. 
	
</LI>
</UL>

<P>
</LI>
<LI>bind_dn
<BR>
If anonymous bind is not allowed on the LDAP server, a DN and password can be used.

<P>
</LI>
<LI>bind_password
<BR>
This password is used, combined with the bind_dn above.

<P>
</LI>
</UL>

<P>
example.ldap : we want to select the professors of mathematics in the university of Rennes1 in France<PRE>
	
	host		ldap.univ-rennes1.fr:389,ldap2.univ-rennes1.fr:390
	suffix		dc=univ-rennes1.fr,dc=fr
	filter		(&amp;(canonic_mail = [sender])(EmployeeType = prof)(subject = math))
	scope		sub
</PRE>

<P>

<H2><A NAME="SECTION001422000000000000000">
13.2.2 Search Condition</A>
</H2>

<P>
The search condition is used in authorization scenarios which are defined and described in (see&nbsp;<A HREF="#scenarios">13</A>) 

<P>
The syntax of this rule is:<PRE>
	search(example.ldap,[sender])      smtp,smime,md5    -&gt; do_it
</PRE>

<P>
The variables used by 'search' are :

<UL>
<LI>the name of the LDAP Configuration file
<BR></LI>
<LI>the [sender]
<BR>
That is to say the sender email address. 
</LI>
</UL>

<P>
Note that <I>Sympa</I> processes maintain a cache of processed search conditions to limit access to the LDAP directory ; each entry has a lifetime of 1 hour in the cache.

<P>
The method of authentication does not change.

<P>

<H1><A NAME="SECTION001430000000000000000">
13.3 scenario inclusion</A>
</H1>

<P>
Scenarios can also contain includes :

<P><PRE>
    subscribe
        include commonreject
        match(, /cru\.fr$/)          smtp,smime -&gt; do_it
	true()                               smtp,smime -&gt; owner
</PRE>

<P>
In this case sympa applies recursively the scenario named <TT>include.commonreject</TT>
before introducing the other rules. This possibility was introduced in
order to facilitate the administration of common rules.

<P>
You can define a set of common scenario rules, used by all lists.
include.<TT>&lt;</TT>action<TT>&gt;</TT>.header is automatically added to evaluated scenarios.

<P>

<H1><A NAME="SECTION001440000000000000000">
13.4 Hidding scenario files</A>
</H1>

<P>
Because <I>Sympa</I> is distributed with many default scenario files, you may want to hidde some of them 
to list owners (to make list admin menus shorter and readable). To hidde a scenario file you should 
create an empty file with the <TT>:ignore</TT> suffix. Depending on where this file has been created
will make it ignored at either a global, robot or list level.

<P>
<I>Example :</I> 
<BLOCKQUOTE>
/usr/local/sympa-stable/etc/my.domain.org/scenari/send.intranetorprivate:ignore

</BLOCKQUOTE>

<P>
The <TT>intranetorprivate</TT> <TT>send</TT> scenario will be hidden (on the web admin interface),
at the my.domain.orgrobot level only.

<P>
<HR>
<!--Navigation Panel-->
<A NAME="tex2html1159"
  HREF="node15.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html1153"
  HREF="sympa.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html1147"
  HREF="node13.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html1155"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html1157"
  HREF="node30.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html1160"
  HREF="node15.html">14. virtual host</A>
<B> Up:</B> <A NAME="tex2html1154"
  HREF="sympa.html">Sympa Mailing Lists Management Software version</A>
<B> Previous:</B> <A NAME="tex2html1148"
  HREF="node13.html">12. Authentication</A>
 &nbsp; <B>  <A NAME="tex2html1156"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A NAME="tex2html1158"
  HREF="node30.html">Index</A></B> 
<!--End of Navigation Panel-->
<ADDRESS>
root
2006-09-25
</ADDRESS>
</BODY>
</HTML>
